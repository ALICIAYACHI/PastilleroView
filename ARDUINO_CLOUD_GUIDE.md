# Gu√≠a de Despliegue en Arduino Cloud para ESP32

Esta gu√≠a te ayudar√° a conectar tu ESP32 a **Arduino IoT Cloud** para poder monitorearlo y controlarlo desde cualquier lugar.

## 1. Preparaci√≥n Inicial

1.  **Crear cuenta**: Ve a [Arduino Cloud](https://cloud.arduino.cc/) y crea una cuenta gratuita.
2.  **Instalar Agente**: Si usas el editor web, descarga e instala el [Arduino Create Agent](https://create.arduino.cc/getting-started/plugin/welcome). Esto permite que el navegador se comunique con tu ESP32 por USB.

## 2. Crear el "Thing" (Dispositivo Virtual)

Un "Thing" es la representaci√≥n digital de tu ESP32 en la nube.

1.  Ve a la secci√≥n **"Things"** en el men√∫ lateral.
2.  Haz clic en **"CREATE THING"**.
3.  Dale un nombre (ej. `Pastillero`).
4.  **Asociar Dispositivo**:
    *   En la secci√≥n "Associated Device", haz clic en **Select Device**.
    *   Elige "Set up a new device" -> "ESP32".
    *   Conecta tu ESP32 al USB. El agente deber√≠a detectarlo.
    *   Sigue los pasos. **IMPORTANTE**: Al final te dar√° un **Device ID** y una **Secret Key**. ¬°Gu√°rdalos! (Descarga el PDF que te ofrecen).
5.  **Configurar Red**:
    *   En la secci√≥n "Network", introduce tu nombre de WiFi (SSID) y contrase√±a.
    *   Introduce la `Secret Key` que obtuviste en el paso anterior.

## 3. Crear Variables (Opcional)

Para ver datos en el Dashboard, necesitas crear variables. Para tu pastillero, sugerimos:

*   **Nombre**: `alarmaActiva`
    *   **Tipo**: Boolean
    *   **Permiso**: Read & Write (Lectura y Escritura)
    *   **Update Policy**: On Change
*   **Nombre**: `ultimoMensaje` (para depuraci√≥n)
    *   **Tipo**: String
    *   **Permiso**: Read Only

## 4. Adaptar tu C√≥digo (`pastillero.ino`)

Arduino Cloud genera autom√°ticamente un esqueleto de c√≥digo (Sketch) y un archivo `thingProperties.h`. Debes fusionar tu l√≥gica actual con ese esqueleto.

### Diferencias Clave:
1.  **Conexi√≥n WiFi**: Ya no usas `WiFi.begin()` manualmente. `ArduinoCloud.begin()` se encarga de todo usando los datos que pusiste en la configuraci√≥n del "Thing".
2.  **Bucle Principal**: El `loop()` debe ser muy r√°pido y contener `ArduinoCloud.update()`.
    *   ‚ö†Ô∏è **EVITA LOS `delay()` LARGOS**: Tu c√≥digo actual tiene `delay(60000)` y `delay(1000)`. Esto desconectar√° el Arduino de la nube. Debes usar `millis()` para temporizaci√≥n (como ya haces en algunas partes).

### Ejemplo de Estructura Adaptada

Cuando abras el editor de Arduino Cloud ("Sketch" tab), ver√°s algo as√≠. Aqu√≠ te muestro c√≥mo integrar tus partes:

**Archivo: `thingProperties.h` (Generado autom√°ticamente, NO LO TOQUES)**
```cpp
// Code generated by Arduino IoT Cloud, DO NOT EDIT.
#include <ArduinoIoTCloud.h>
#include <Arduino_ConnectionHandler.h>

const char DEVICE_LOGIN_NAME[]  = "TU_DEVICE_ID";
const char SSID[]               = "TU_WIFI";
const char PASS[]               = "TU_PASSWORD";
const char DEVICE_KEY[]         = "TU_SECRET_KEY";

void onAlarmaActivaChange(); // Funci√≥n que se llama si cambias la variable desde la nube

bool alarmaActiva;
String ultimoMensaje;

void initProperties(){
  ArduinoCloud.setBoardId(DEVICE_LOGIN_NAME);
  ArduinoCloud.setSecretDeviceKey(DEVICE_KEY);
  ArduinoCloud.addProperty(alarmaActiva, READWRITE, ON_CHANGE, onAlarmaActivaChange);
  ArduinoCloud.addProperty(ultimoMensaje, READ, ON_CHANGE);
}

WiFiConnectionHandler ArduinoIoTPreferredConnection(SSID, PASS);
```

**Archivo: `Pastillero.ino` (Tu c√≥digo principal)**

```cpp
#include "thingProperties.h"
// ... TUS LIBRER√çAS (WiFi, HTTPClient, Servo, etc.) ...
// ... TUS VARIABLES GLOBALES ...

void setup() {
  Serial.begin(115200);
  delay(1500);

  // Configuraci√≥n de pines y servos
  pinMode(LED_PIN, OUTPUT);
  // ... resto de tu setup de hardware ...

  // Inicializar propiedades de Arduino Cloud
  initProperties();

  // Conectar a Arduino Cloud
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);

  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();
  
  // NO necesitas WiFi.begin(), ArduinoCloud lo hace.
  // Esperar a conexi√≥n si es necesario para obtener hora NTP
}

void loop() {
  ArduinoCloud.update(); // ¬°CR√çTICO! Mantiene la conexi√≥n viva
  
  // Tu l√≥gica de polling al backend Render
  // Aseg√∫rate de que obtenerTratamientos() no tarde demasiado
  if (millis() - ultimaConsultaBackend >= INTERVALO_CONSULTA) {
     obtenerTratamientos();
     ultimaConsultaBackend = millis();
  }

  // ... Resto de tu l√≥gica ...
  
  // IMPORTANTE: Reemplaza los delay() largos por l√≥gica con millis()
  // Si usas delay(60000), el Arduino se desconectar√° de la nube.
}

// ... TUS FUNCIONES (obtenerTratamientos, manejarBoton, etc.) ...
```

## 5. Subir el C√≥digo

1.  En el editor web de Arduino Cloud, pega tu c√≥digo adaptado en la pesta√±a `.ino`.
2.  Aseg√∫rate de copiar tambi√©n cualquier otra funci√≥n o definici√≥n necesaria.
3.  Haz clic en el bot√≥n **Verify** (‚úî) para compilar.
4.  Haz clic en el bot√≥n **Upload** (‚û°) para subirlo al ESP32.

## 6. Crear el Dashboard

1.  Ve a la pesta√±a **Dashboards**.
2.  Crea uno nuevo.
3.  A√±ade "Widgets" y vinc√∫lalos a tus variables (ej. un interruptor para `alarmaActiva`).
4.  ¬°Ahora puedes ver el estado de tu pastillero desde el m√≥vil!

---

### üí° Consejos para tu Proyecto Espec√≠fico

*   **Render vs Arduino Cloud**: Tu proyecto ya se conecta a Render. Puedes mantener eso. Arduino Cloud te servir√° principalmente para **ver el estado en tiempo real** (si la alarma suena, si se tom√≥ la pastilla) sin tener que mirar los logs de Render o el Serial Monitor.
*   **Conflictos**: `WiFiClientSecure` puede coexistir con Arduino Cloud, pero ambos usan recursos. Si notas inestabilidad, intenta reducir la frecuencia de consulta a Render.
